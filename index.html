<!DOCTYPE html>
<html>
<head>
    <title>Fuel System - Admin Portal</title>
    <style>
        body{ font-family:'Segoe UI',sans-serif; margin:20px; background-color:#f4f7f6; }
        .container{ max-width:1200px; margin:auto; background:white; padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
        .navbar{ position:fixed; top:0; left:0; width:100%; background:#1e293b; padding:12px 30px; display:flex; gap:30px; z-index:1000; }
        .navbar a{ color:white; text-decoration:none; font-weight:600; }
        h2{ color:#2c3e50; border-bottom:2px solid #3498db; padding-bottom:10px; margin-top:60px; }
        table{ border-collapse:collapse; width:100%; margin-top:20px; }
        th,td{ border:1px solid #dfe6e9; padding:12px; text-align:left; }
        th{ background-color:#3498db; color:white; font-size:13px; }
        tr:hover{ background-color: #f1f1f1; cursor: pointer; }
        
        /* Status Colors */
        .status-pending { color: #f39c12; font-weight: bold; }
        .status-approved { color: #27ae60; font-weight: bold; }
        .status-rejected { color: #e74c3c; font-weight: bold; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; width: 40%; border-radius: 12px; text-align: center; position: relative; }
        .modal-img { width: 100%; max-height: 350px; object-fit: contain; border-radius: 8px; margin: 15px 0; border: 1px solid #ddd; }
        .btn-approve { background: #27ae60; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-reject { background: #e74c3c; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<div class="navbar">
    <a href="index.html">Fuel Request Form</a>
    <a href="table.html" style="color:#38bdf8">Admin List</a>
</div>

<div class="container">
    <h2>Fuel Request Management</h2>
    <p><small><i>* Click on any row to Approve or Reject the request.</i></small></p>

    <table id="dataTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Driver</th>
                <th>Lorry</th>
                <th>Mileage</th>
                <th>Liters</th>
                <th>Date</th>
                <th>Receipt</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="statusModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>Review Fuel Request</h3>
        <hr>
        <div id="modalDetails" style="text-align: left; line-height: 1.6;"></div>
        <img id="modalImg" class="modal-img" src="" alt="No Image Available">
        <div style="margin-top: 20px;">
            <button class="btn-approve" onclick="submitStatus('Approved')">Approve Request</button>
            <button class="btn-reject" onclick="submitStatus('Rejected')">Reject Request</button>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwdy3zJlxQO_kFijZZAmqdoLWB8qT8Kk84G3ELOAXtcSRlJ_xoIf7gLgoqHTcFT06nj/exec'; // PASTE YOUR URL HERE
    let allData = [];
    let currentRowIndex = null;

    function loadData() {
        fetch(scriptURL)
            .then(res => res.json())
            .then(data => {
                allData = data.slice(1);
                renderTable(allData);
            });
    }

    function renderTable(data) {
        const tableBody = document.querySelector("#dataTable tbody");
        tableBody.innerHTML = "";

        data.forEach((row, index) => {
            let tr = document.createElement("tr");
            let sheetIndex = index + 2; // +1 for 0-index, +1 for header row
            tr.onclick = () => openModal(row, sheetIndex);

            row.forEach((cell, i) => {
                let td = document.createElement("td");
                if (i === 6) { // Receipt Column
                    td.innerHTML = cell ? `<span style="color:#3498db; font-size:12px;">View Receipt</span>` : "No Image";
                } else if (i === 7) { // Status Column
                    let status = cell || "Pending";
                    td.innerHTML = `<span class="status-${status.toLowerCase()}">${status}</span>`;
                } else {
                    td.textContent = cell;
                }
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    function openModal(row, sheetIndex) {
        currentRowIndex = sheetIndex;
        document.getElementById("modalDetails").innerHTML = `
            <strong>Request ID:</strong> ${row[0]} <br>
            <strong>Driver:</strong> ${row[1]} <br>
            <strong>Lorry:</strong> ${row[2]} <br>
            <strong>Liters Requested:</strong> ${row[4]}
        `;

        const idMatch = row[6] ? row[6].match(/[-\w]{25,}/) : null;
        document.getElementById("modalImg").src = idMatch ? 
            `https://drive.google.com/thumbnail?id=${idMatch[0]}&sz=w600` : "https://via.placeholder.com/400x300?text=No+Receipt+Found";
        
        document.getElementById("statusModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("statusModal").style.display = "none";
    }

    function submitStatus(status) {
        if(!confirm("Update status to " + status + "?")) return;
        
        const params = new URLSearchParams();
        params.append('action', 'updateStatus');
        params.append('row', currentRowIndex);
        params.append('status', status);

        fetch(scriptURL, { 
            method: 'POST', 
            body: params,
            mode: 'no-cors' // Use no-cors for simple App Script triggers
        })
        .then(() => {
            alert("Success!");
            closeModal();
            loadData(); // Refresh list
        })
        .catch(err => alert("Error updating status."));
    }

    loadData();
</script>

</body>
</html>
